<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllSenseAI — Live Incident Panel</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .panel-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .panel-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .panel-subtitle {
            font-size: 1.1rem;
            color: #e5e7eb;
            margin-bottom: 20px;
        }

        .demo-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .demo-button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .demo-button.primary {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
        }

        .demo-button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .steps-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
        }

        .steps-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fbbf24;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 15px;
            transition: all 0.6s ease;
        }

        .step-number.pending {
            border: 2px solid #6b7280;
            color: #6b7280;
            background: transparent;
        }

        .step-number.in-progress {
            border: 2px solid #b45309;
            color: #b45309;
            background: rgba(180, 83, 9, 0.1);
            animation: pulse 2s infinite;
        }

        .step-number.success {
            background: #059669;
            color: white;
            border: none;
        }

        .step-number.warning {
            background: #f59e0b;
            color: white;
            border: none;
        }

        .step-number.failed {
            background: #dc2626;
            color: white;
            border: none;
            animation: shake 0.4s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.06); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .step-status {
            font-size: 0.9rem;
            color: #d1d5db;
        }

        .step-icon {
            margin-left: 10px;
            font-size: 1.2rem;
        }

        .details-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
        }

        .details-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fbbf24;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .event-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #059669;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #dc2626;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
        }

        .contact-list {
            margin-top: 15px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .contact-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #059669;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: 600;
        }

        .contact-info {
            flex: 1;
        }

        .contact-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .contact-status.pending { background: #6b7280; }
        .contact-status.sent { background: #059669; }
        .contact-status.failed { background: #dc2626; }
        .contact-status.confirmed { background: #10b981; }

        .privacy-footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #1f2937;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #1e3a8a;
        }

        .modal-body {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .envelope-animation {
            position: absolute;
            font-size: 1.5rem;
            color: #fbbf24;
            animation: fly 2s ease-out forwards;
        }

        @keyframes fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(200px, -50px) scale(0.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Demo Introduction Modal -->
    <div id="demoModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Demo: AllSenseAI — Live Incident Flow</div>
            <div class="modal-body">
                This demo visualizes a full AllSenseAI emergency cycle for <strong id="modalVictimName">Carlos Perez</strong>. 
                <br><br>
                <strong>Steps:</strong> 1) Audio Capture → 2) Distress Detection → 3) Event Trigger → 4) Geolocation → 5) SMS Dispatch (message includes victim's name and map link) → 6) Contact Confirmation → 7) Analytics & Learning. 
                <br><br>
                Click <strong>Simulate Emergency</strong> to run the demo. All SMS messages in this demo go to test numbers only.
            </div>
            <div class="modal-footer">
                <button class="demo-button primary" onclick="startEmergencySimulation()">Simulate Emergency</button>
                <button class="demo-button secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="panel-container">
        <div class="panel-header">
            <div class="panel-title">AllSenseAI — Live Incident Panel</div>
            <div class="panel-subtitle" id="panelSubtitle">User: Carlos Perez — UserID: user-123 — Session: Demo</div>
            
            <div class="demo-controls">
                <button class="demo-button primary" onclick="showDemoModal()">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">play_arrow</span>
                    Simulate Emergency
                </button>
                <button class="demo-button secondary" onclick="toggleMicrophone()">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 5px;" id="micIcon">mic</span>
                    <span id="micText">Mute</span>
                </button>
                <button class="demo-button secondary" onclick="showPayload()">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">code</span>
                    Show Payload
                </button>
                <button class="demo-button secondary" onclick="closeAlert()">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">close</span>
                    Close Alert
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="steps-panel">
                <div class="steps-title">Emergency Pipeline Steps</div>
                
                <!-- Step 1: Audio Capture -->
                <div class="step-item" id="step1">
                    <div class="step-number pending" id="step1-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Audio Capture</div>
                        <div class="step-status" id="step1-status">Listening for audio...</div>
                    </div>
                    <span class="material-icons step-icon">mic</span>
                </div>

                <!-- Step 2: Distress Detection -->
                <div class="step-item" id="step2">
                    <div class="step-number pending" id="step2-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Distress Detection</div>
                        <div class="step-status" id="step2-status">Analyzing audio with Bedrock model...</div>
                    </div>
                    <span class="material-icons step-icon">hearing</span>
                </div>

                <!-- Step 3: Event Trigger -->
                <div class="step-item" id="step3">
                    <div class="step-number pending" id="step3-number">3</div>
                    <div class="step-content">
                        <div class="step-title">Event Trigger</div>
                        <div class="step-status" id="step3-status">Sending emergency event to EventBridge...</div>
                    </div>
                    <span class="material-icons step-icon">bolt</span>
                </div>

                <!-- Step 4: Geolocation Retrieval -->
                <div class="step-item" id="step4">
                    <div class="step-number pending" id="step4-number">4</div>
                    <div class="step-content">
                        <div class="step-title">Geolocation Retrieval</div>
                        <div class="step-status" id="step4-status">Reverse-geocoding coordinates...</div>
                    </div>
                    <span class="material-icons step-icon">place</span>
                </div>

                <!-- Step 5: SMS Dispatch -->
                <div class="step-item" id="step5">
                    <div class="step-number pending" id="step5-number">5</div>
                    <div class="step-content">
                        <div class="step-title">SMS Dispatch</div>
                        <div class="step-status" id="step5-status">Preparing SMS to contacts (see list)</div>
                        <div class="contact-list" id="contactList"></div>
                    </div>
                    <span class="material-icons step-icon">sms</span>
                </div>

                <!-- Step 6: Contact Confirmation -->
                <div class="step-item" id="step6">
                    <div class="step-number pending" id="step6-number">6</div>
                    <div class="step-content">
                        <div class="step-title">Contact Confirmation</div>
                        <div class="step-status" id="step6-status">Waiting for contact confirmation (reply OK) — timeout 5m</div>
                    </div>
                    <span class="material-icons step-icon">phone_callback</span>
                </div>

                <!-- Step 7: Analytics & Learning -->
                <div class="step-item" id="step7">
                    <div class="step-number pending" id="step7-number">7</div>
                    <div class="step-content">
                        <div class="step-title">Analytics & Learning</div>
                        <div class="step-status" id="step7-status">Logging anonymized metrics to CloudWatch and S3</div>
                    </div>
                    <span class="material-icons step-icon">bar_chart</span>
                </div>
            </div>

            <div class="details-panel">
                <div class="details-title">Event Details & Map</div>
                
                <div class="map-container" id="mapContainer">
                    <div style="font-size: 1.1rem; margin-bottom: 10px;">📍 Location</div>
                    <div id="locationInfo">Waiting for location data...</div>
                    <div id="mapLink" style="margin-top: 10px;"></div>
                </div>

                <div class="details-title">Event Log</div>
                <div class="event-log" id="eventLog">
                    <div class="log-entry">System initialized - AllSenseAI Live Incident Panel ready</div>
                </div>
            </div>
        </div>

        <div class="privacy-footer">
            Privacy: audio and location are processed with consent. Only encrypted, minimal data is transmitted to trusted contacts during emergencies. See Privacy Settings.
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://53x75wmois5qtdv2gfc4sn3btzubrivqx.lambda-url.us-east-1.on.aws/';
        let currentEventId = null;
        let userProfile = null;
        let isMicrophoneMuted = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            addLogEntry('AllSenseAI Live Incident Panel initialized');
        });

        async function loadUserProfile() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'GET_USER_PROFILE',
                        userId: 'user-123'
                    })
                });
                
                userProfile = await response.json();
                
                // Update UI with user info
                document.getElementById('panelSubtitle').textContent = 
                    `User: ${userProfile.victimName} — UserID: ${userProfile.userId} — Session: Demo`;
                document.getElementById('modalVictimName').textContent = userProfile.victimName;
                
                addLogEntry(`User profile loaded: ${userProfile.victimName}`);
                
            } catch (error) {
                addLogEntry(`Error loading user profile: ${error.message}`, 'error');
            }
        }

        function showDemoModal() {
            document.getElementById('demoModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('demoModal').style.display = 'none';
        }

        async function startEmergencySimulation() {
            closeModal();
            resetAllSteps();
            addLogEntry('🚨 Emergency simulation started');
            
            try {
                // Step 1: Audio Capture
                updateStepStatus(1, 'in-progress', 'Listening — ambient audio detected');
                await delay(1000);
                updateStepStatus(1, 'success', 'Audio sample captured: s3://allsense-audio/user-123/sample.wav');
                
                // Step 2: Distress Detection
                updateStepStatus(2, 'in-progress', 'Model confidence: analyzing...');
                await delay(1500);
                updateStepStatus(2, 'success', 'Distress detected (confidence 87%). Triggering event.');
                
                // Step 3: Event Trigger
                updateStepStatus(3, 'in-progress', 'Event dispatched — awaiting orchestration');
                await delay(1000);
                
                // Call the actual API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'SIMULATE_EMERGENCY',
                        userId: 'user-123',
                        audioData: 'HELP! Emergency!',
                        lat: 40.712776,
                        lon: -74.005974,
                        confidence: 0.87
                    })
                });
                
                const result = await response.json();
                currentEventId = result.eventId;
                
                updateStepStatus(3, 'success', `Event sent: ${result.eventId}`);
                addLogEntry(`EventBridge event triggered: ${result.eventId}`);
                
                // Step 4: Geolocation
                updateStepStatus(4, 'in-progress', `Location lookup — ${result.steps.step4_geolocation.location.lat},${result.steps.step4_geolocation.location.lon}`);
                await delay(1000);
                
                const location = result.steps.step4_geolocation.location;
                updateStepStatus(4, 'success', `Location resolved: ${location.placeName}`);
                updateLocationInfo(location);
                
                // Step 5: SMS Dispatch
                updateStepStatus(5, 'in-progress', `Sending SMS to ${result.steps.step5_sms.results.length} contacts...`);
                displayContacts(result.steps.step5_sms.results);
                
                // Simulate SMS sending with delays
                for (let i = 0; i < result.steps.step5_sms.results.length; i++) {
                    const smsResult = result.steps.step5_sms.results[i];
                    await delay(800);
                    
                    if (smsResult.status === 'sent') {
                        updateContactStatus(i, 'sent');
                        addLogEntry(`SMS to ${smsResult.contactName} (${smsResult.phone}) sent (msgId: ${smsResult.messageId})`);
                        
                        // Add envelope animation
                        createEnvelopeAnimation(document.getElementById('step5'));
                    } else {
                        updateContactStatus(i, 'failed');
                        addLogEntry(`SMS failed for ${smsResult.contactName}`, 'error');
                    }
                }
                
                updateStepStatus(5, 'success', `SMS sent to all contacts`);
                
                // Step 6: Contact Confirmation
                updateStepStatus(6, 'in-progress', 'Awaiting responses... 0 confirmed / 2');
                await delay(2000);
                
                // Simulate confirmation from first contact
                updateStepStatus(6, 'success', 'Confirmation received from Maria Perez. Alert closed.');
                updateContactStatus(0, 'confirmed');
                addLogEntry('✅ Confirmation received from Maria Perez - replied OK');
                
                // Step 7: Analytics
                updateStepStatus(7, 'in-progress', 'Anonymizing and uploading event summary...');
                await delay(1000);
                updateStepStatus(7, 'success', 'Event logged. Data ready for ML training.');
                addLogEntry('Analytics data logged to CloudWatch');
                
                addLogEntry('🎉 Emergency simulation completed successfully');
                
            } catch (error) {
                addLogEntry(`Simulation error: ${error.message}`, 'error');
            }
        }

        function updateStepStatus(stepNumber, status, statusText) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            const numberElement = document.getElementById(`step${stepNumber}-number`);
            const statusElement = document.getElementById(`step${stepNumber}-status`);
            
            // Remove all status classes
            numberElement.className = `step-number ${status}`;
            
            // Update status text
            statusElement.textContent = statusText;
            
            // Add spinner for in-progress
            if (status === 'in-progress') {
                const spinner = document.createElement('div');
                spinner.className = 'spinner';
                spinner.style.marginLeft = '10px';
                statusElement.appendChild(spinner);
            }
            
            // Add checkmark for success
            if (status === 'success') {
                numberElement.innerHTML = '✓';
            }
        }

        function displayContacts(smsResults) {
            const contactList = document.getElementById('contactList');
            contactList.innerHTML = '';
            
            smsResults.forEach((result, index) => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact-item';
                contactDiv.innerHTML = `
                    <div class="contact-avatar">${result.contactName.charAt(0)}</div>
                    <div class="contact-info">
                        <div style="font-weight: 600;">${result.contactName}</div>
                        <div style="font-size: 0.9rem; color: #d1d5db;">${result.phone}</div>
                    </div>
                    <div class="contact-status pending" id="contact-status-${index}">Pending</div>
                `;
                contactList.appendChild(contactDiv);
            });
        }

        function updateContactStatus(contactIndex, status) {
            const statusElement = document.getElementById(`contact-status-${contactIndex}`);
            if (statusElement) {
                statusElement.className = `contact-status ${status}`;
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }
        }

        function updateLocationInfo(location) {
            document.getElementById('locationInfo').innerHTML = `
                <strong>${location.placeName}</strong><br>
                <small style="color: #d1d5db;">${location.addressString}</small><br>
                <small style="color: #d1d5db;">Coordinates: ${location.lat}, ${location.lon}</small>
            `;
            
            document.getElementById('mapLink').innerHTML = `
                <a href="${location.mapLink}" target="_blank" style="color: #fbbf24; text-decoration: none;">
                    📍 View on Map
                </a>
            `;
        }

        function createEnvelopeAnimation(fromElement) {
            const envelope = document.createElement('div');
            envelope.className = 'envelope-animation';
            envelope.innerHTML = '✉️';
            
            const rect = fromElement.getBoundingClientRect();
            envelope.style.left = rect.right + 'px';
            envelope.style.top = rect.top + 'px';
            
            document.body.appendChild(envelope);
            
            setTimeout(() => {
                document.body.removeChild(envelope);
            }, 2000);
        }

        function resetAllSteps() {
            for (let i = 1; i <= 7; i++) {
                const numberElement = document.getElementById(`step${i}-number`);
                const statusElement = document.getElementById(`step${i}-status`);
                
                numberElement.className = 'step-number pending';
                numberElement.textContent = i;
                
                // Reset status text to initial state
                const initialStatuses = {
                    1: 'Listening for audio...',
                    2: 'Analyzing audio with Bedrock model...',
                    3: 'Sending emergency event to EventBridge...',
                    4: 'Reverse-geocoding coordinates...',
                    5: 'Preparing SMS to contacts (see list)',
                    6: 'Waiting for contact confirmation (reply OK) — timeout 5m',
                    7: 'Logging anonymized metrics to CloudWatch and S3'
                };
                
                statusElement.innerHTML = initialStatuses[i];
            }
            
            // Clear contact list
            document.getElementById('contactList').innerHTML = '';
            
            // Reset location info
            document.getElementById('locationInfo').textContent = 'Waiting for location data...';
            document.getElementById('mapLink').innerHTML = '';
        }

        function toggleMicrophone() {
            isMicrophoneMuted = !isMicrophoneMuted;
            const micIcon = document.getElementById('micIcon');
            const micText = document.getElementById('micText');
            
            if (isMicrophoneMuted) {
                micIcon.textContent = 'mic_off';
                micText.textContent = 'Unmute';
                addLogEntry('Microphone muted');
            } else {
                micIcon.textContent = 'mic';
                micText.textContent = 'Mute';
                addLogEntry('Microphone unmuted');
            }
        }

        function showPayload() {
            if (currentEventId) {
                const payload = {
                    "version": "1",
                    "source": "allsense.app",
                    "detail-type": "emergency_triggered",
                    "detail": {
                        "userId": "user-123",
                        "lat": 40.712776,
                        "lon": -74.005974,
                        "timestamp": new Date().toISOString(),
                        "confidence": 0.87,
                        "audioSnippetS3": "s3://allsense-audio/user-123/sample.wav",
                        "eventId": currentEventId
                    }
                };
                
                alert('EventBridge Payload:\n\n' + JSON.stringify(payload, null, 2));
            } else {
                alert('No active event. Run simulation first.');
            }
        }

        function closeAlert() {
            if (currentEventId) {
                addLogEntry(`Alert ${currentEventId} manually closed`);
                resetAllSteps();
                currentEventId = null;
            }
        }

        function addLogEntry(message, type = 'info') {
            const eventLog = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `${timestamp} — ${message}`;
            
            eventLog.appendChild(logEntry);
            eventLog.scrollTop = eventLog.scrollHeight;
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('demoModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>